<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart QR Attendance System</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    h2 {
      text-align: center;
    }
    .qr-box, .scanner-box {
      margin-top: 20px;
      text-align: center;
    }
    #qr-canvas, #reader {
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="container" id="main-container">
  <h2>Smart QR Attendance</h2>

  <div id="login-section">
    <button onclick="showLogin('staff')">Staff Login</button>
    <button onclick="showLogin('student')">Student Login</button>
  </div>

  <div id="staff-login" style="display:none">
    <h3>Staff Login</h3>
    <input id="college" list="collegeList" placeholder="College Name">
    <datalist id="collegeList">
      <option value="Loganathan Narayanasamy College">
      <option value="Anna University">
      <option value="PSG College of Technology">
    </datalist>
    <input id="department" list="deptList" placeholder="Department">
    <datalist id="deptList">
      <option value="Computer Science">
      <option value="BCA">
      <option value="Physics">
    </datalist>
    <input id="year" list="yearList" placeholder="Year">
    <datalist id="yearList">
      <option value="I">
      <option value="II">
      <option value="III">
    </datalist>
    <input id="shift" list="shiftList" placeholder="Shift">
    <datalist id="shiftList">
      <option value="I">
      <option value="II">
    </datalist>
    <button onclick="staffLogin()">Login as Staff</button>
  </div>

  <div id="student-login" style="display:none">
    <h3>Student Login</h3>
    <input id="regno" placeholder="Register Number" />
    <input id="sname" placeholder="Name" />
    <button onclick="studentLogin()">Login as Student</button>
  </div>

  <div id="student-dashboard" style="display:none">
    <h3>Welcome, <span id="student-name"></span></h3>
    <div class="qr-box">
      <canvas id="qr-canvas"></canvas><br>
      <button onclick="downloadQR()">Download QR</button>
    </div>
    <div>
      <h4>Your Attendance</h4>
      <ul id="student-attendance"></ul>
    </div>
  </div>

  <div id="staff-dashboard" style="display:none">
    <h3>Welcome Staff</h3>
    <p><b>College:</b> <span id="collegeName"></span></p>
    <button onclick="startScan()">Scan QR</button>
    <div id="reader" style="width:100%; margin-top:10px;"></div>
    <div>
      <h4>Today's Attendance</h4>
      <ul id="attendance-list"></ul>
    </div>
  </div>
</div>

<script>
let currentStudent = "";
let staffDetails = {};

function showLogin(role) {
  document.getElementById('login-section').style.display = 'none';
  if (role === 'staff') {
    document.getElementById('staff-login').style.display = 'block';
  } else {
    document.getElementById('student-login').style.display = 'block';
  }
}

function staffLogin() {
  const college = document.getElementById("college").value;
  const department = document.getElementById("department").value;
  const year = document.getElementById("year").value;
  const shift = document.getElementById("shift").value;

  if (!college || !department || !year || !shift) {
    alert("Fill all fields!");
    return;
  }

  staffDetails = { college, department, year, shift };
  localStorage.setItem("staffDetails", JSON.stringify(staffDetails));
  document.getElementById("collegeName").textContent = college;
  document.getElementById("staff-login").style.display = "none";
  document.getElementById("staff-dashboard").style.display = "block";
}

function studentLogin() {
  const reg = document.getElementById("regno").value.trim();
  const name = document.getElementById("sname").value.trim();
  if (!reg || !name) {
    alert("Enter valid Register Number and Name!");
    return;
  }
  currentStudent = reg;
  document.getElementById("student-name").textContent = name;
  document.getElementById("student-login").style.display = "none";
  document.getElementById("student-dashboard").style.display = "block";
  QRCode.toCanvas(document.getElementById("qr-canvas"), reg);
  loadStudentAttendance(reg);
}

function downloadQR() {
  const canvas = document.getElementById("qr-canvas");
  const link = document.createElement("a");
  link.download = currentStudent + "_qr.png";
  link.href = canvas.toDataURL();
  link.click();
}

function startScan() {
  const qrbox = document.getElementById("reader");
  qrbox.innerHTML = "";

  const scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (regno) => {
      scanner.stop();
      markAttendance(regno);
    },
    (err) => { console.warn(err); }
  );
}

function markAttendance(regno) {
  const today = new Date().toLocaleDateString();
  let all = JSON.parse(localStorage.getItem("attendance")) || {};
  if (!all[regno]) all[regno] = [];
  if (!all[regno].includes(today)) {
    all[regno].push(today);
    localStorage.setItem("attendance", JSON.stringify(all));
  }
  alert("Attendance marked for: " + regno);
  showStaffAttendance();
}

function loadStudentAttendance(regno) {
  const ul = document.getElementById("student-attendance");
  ul.innerHTML = "";
  let all = JSON.parse(localStorage.getItem("attendance")) || {};
  if (all[regno]) {
    all[regno].forEach(d => {
      const li = document.createElement("li");
      li.textContent = d;
      ul.appendChild(li);
    });
  }
}

function showStaffAttendance() {
  const ul = document.getElementById("attendance-list");
  ul.innerHTML = "";
  let all = JSON.parse(localStorage.getItem("attendance")) || {};
  Object.keys(all).forEach(regno => {
    all[regno].forEach(date => {
      const li = document.createElement("li");
      li.textContent = regno + " â†’ " + date;
      ul.appendChild(li);
    });
  });
}
</script>
</body>
</html>